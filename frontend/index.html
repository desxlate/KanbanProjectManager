<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Project Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .kanban-column {
            min-height: 70vh;
            transition: all 0.3s ease;
        }
        .kanban-column:hover {
            transform: translateY(-5px);
        }
        .task-card {
            transition: all 0.2s ease;
            cursor: grab;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .task-card:active {
            cursor: grabbing;
        }
        .priority-high {
            border-left: 4px solid #ef4444;
        }
        .priority-medium {
            border-left: 4px solid #f59e0b;
        }
        .priority-low {
            border-left: 4px solid #10b981;
        }
        .dropzone {
            min-height: 100px;
            transition: background-color 0.3s;
        }
        .dropzone.dragover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        .status-backlog {
          border-left: 4px solid #9CA3AF;
        }

        .status-todo {
          border-left: 4px solid #3B82F6;
        }

        .status-inprogress {
          border-left: 4px solid #FBBF24;
        }

        .status-done {
          border-left: 4px solid #10B981;
        }
        @keyframes bounce {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-8px); }
        }
        .animate-bounce {
          animation: bounce 1.5s infinite;
        }

    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-project-diagram text-3xl"></i>
                    <h1 class="text-2xl font-bold">Kanban Project Manager</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="newProjectBlock" class="hidden">
                        <button id="newProjectBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-medium hover:bg-indigo-50 transition">
                            <i class="fas fa-plus mr-2"></i>–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                        </button>
                    </div>
                    <div id="authButtons" class="flex items-center space-x-2">
                        <button id="loginBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-medium hover:bg-indigo-50 transition">–í–æ–π—Ç–∏</button>
                        <button id="registerBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-medium hover:bg-indigo-50 transition">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                    <div id="avatarBlock" class="relative hidden">
                        <div id="userAvatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm cursor-pointer border-2 border-white"></div>
                        <div id="avatarDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                            <a href="#" id="profileBtn" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">–ü—Ä–æ—Ñ–∏–ª—å</a>
                            <a href="#" id="settingsBtn" class="block px-4 py-2 text-gray-800 hover:bg-indigo-100">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-gray-800 hover:bg-red-100">–í—ã–π—Ç–∏</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ -->
    <div id="onboardingHint" class="hidden absolute top-[90px] right-[80px] z-50 flex items-center space-x-2 animate-bounce">
      <div class="bg-white border border-indigo-300 rounded-xl shadow-lg px-4 py-2 text-indigo-700 font-medium">
        –ù–∞–∂–º–∏ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç!
      </div>
      <svg width="70" height="70" viewBox="0 0 100 100">
        <defs>
          <marker id="arrow" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto">
            <path d="M0,0 L10,5 L0,10 Z" fill="#3B82F6"/>
          </marker>
        </defs>
        <path d="M10,50 Q70,30 15,10" stroke="#3B82F6" stroke-width="5" fill="none" marker-end="url(#arrow)" />
      </svg>
    </div>

    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª -->
    <div id="welcomeSection" class="hidden flex flex-col items-center justify-center min-h-[calc(100vh-96px)] text-center px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Kanban Project Manager</h2>
        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
            –ü–ª–∞–Ω–∏—Ä—É–π, –æ—Ä–≥–∞–Ω–∏–∑—É–π –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π –∑–∞–¥–∞—á–∏ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã —Å –ø–æ–º–æ—â—å—é —É–¥–æ–±–Ω–æ–π –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏.
            –°–æ–∑–¥–∞–π –ø—Ä–æ–µ–∫—Ç ‚Äî –∏ –Ω–∞—á–Ω–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!
        </p>
    </div>     

    <!-- Projects -->
    <div id="projectList" class="container mx-auto px-4 py-6 space-y-6"></div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
                    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫—Ä–µ—Å—Ç–∏–∫) -->
                    <button type="button" id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                      <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="taskForm">
                    <div class="mb-4">
                        <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                        <input type="text" id="taskTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="taskDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                            <select id="taskPriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="low">–ù–∏–∑–∫–∏–π</option>
                                <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                            </select>
                        </div>
                        <div class="mb-4">
                          <label for="taskStatus" class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                          <select id="taskStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="backlog">–ë—ç–∫–ª–æ–≥</option>
                            <option value="todo">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                            <option value="inprogress">–í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="done">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                          </select>
                        </div>
                        <div>
                            <label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-1">–°—Ä–æ–∫</label>
                            <input type="date" id="taskDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —Ñ–æ—Ä–º—ã -->
                    <div class="flex justify-end space-x-3">
                      <button type="button" id="cancelTaskBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                      <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl w-full max-w-md mx-4">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (–∫—Ä–µ—Å—Ç–∏–∫) -->
            <button type="button" id="closeEditTaskModalBtn" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="editTaskForm">
            <input type="hidden" id="editTaskId">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" id="editTaskTitle" class="w-full px-3 py-2 border rounded-md">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea id="editTaskDescription" class="w-full px-3 py-2 border rounded-md"></textarea>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
              <select id="editTaskPriority" class="w-full px-3 py-2 border rounded-md">
                <option value="low">–ù–∏–∑–∫–∏–π</option>
                <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
              <select id="editTaskStatus" class="w-full px-3 py-2 border rounded-md">
                <option value="backlog">–ë—ç–∫–ª–æ–≥</option>
                <option value="todo">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                <option value="inprogress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="editTaskDueDate" class="block text-sm font-medium text-gray-700 mb-1">–°—Ä–æ–∫</label>
              <input type="date" id="editTaskDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">–£—á–∞—Å—Ç–Ω–∏–∫–∏</label>
              <div class="flex flex-wrap gap-2">
                <div class="flex items-center">
                  <input type="checkbox" id="user1-edit" data-user-id="1" class="hidden peer">
                  <label for="user1-edit" class="flex items-center cursor-pointer">
                    <img src="https://randomuser.me/api/portraits/women/44.jpg"
                        class="w-8 h-8 rounded-full peer-checked:ring-2 peer-checked:ring-indigo-500">
                  </label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="user2-edit" data-user-id="2" class="hidden peer">
                  <label for="user2-edit" class="flex items-center cursor-pointer">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg"
                        class="w-8 h-8 rounded-full peer-checked:ring-2 peer-checked:ring-indigo-500">
                  </label>
                </div>
              </div>
            </div>
            <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —Ñ–æ—Ä–º—ã -->
            <div class="flex justify-end space-x-3">
              <button type="button" id="cancelEditTaskBtn" class="text-gray-600">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl w-full max-w-md mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
                    <button id="closeProjectModalBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="projectForm">
                    <div class="mb-4">
                        <label for="projectName" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" id="projectName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="projectDescription" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="projectDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="projectStartDate" class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                            <input type="date" id="projectStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="projectEndDate" class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <input type="date" id="projectEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelProjectBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl w-full max-w-md mx-4">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h3>
            <button id="closeEditProjectModalBtn" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="editProjectForm">
            <input type="hidden" id="editProjectId">
            <div class="mb-4">
              <label for="editProjectName" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
              <input type="text" id="editProjectName" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
              <label for="editProjectDescription" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea id="editProjectDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label for="editProjectStartDate" class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                <input type="date" id="editProjectStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              </div>
              <div>
                <label for="editProjectEndDate" class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                <input type="date" id="editProjectEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              </div>
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" id="cancelEditProjectBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl w-full max-w-md mx-4 p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">–í—Ö–æ–¥</h3>
          <button id="closeLoginModalBtn" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="loginForm">
          <div class="mb-4">
            <label class="block mb-1 text-sm font-medium text-gray-700">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="loginUsername" class="w-full border px-3 py-2 rounded-md" required>
          </div>
          <div class="mb-4">
            <label class="block mb-1 text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="loginPassword" class="w-full border px-3 py-2 rounded-md" required>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" id="cancelLoginBtn" class="px-4 py-2 text-gray-600">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">–í–æ–π—Ç–∏</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl w-full max-w-md mx-4 p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
          <button id="closeRegisterModalBtn" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="registrationForm">
          <div class="mb-4">
            <label class="block mb-1 text-sm font-medium text-gray-700">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="registerUsername" class="w-full border px-3 py-2 rounded-md" required>
          </div>
          <div class="mb-4">
            <label class="block mb-1 text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="registerPassword" class="w-full border px-3 py-2 rounded-md" required>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" id="cancelRegisterBtn" class="px-4 py-2 text-gray-600">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>
        </form>
      </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let draggedTask = null;
    loadProfile();
    loadProjects();
    loadTasks();
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
    async function loadProfile() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            document.getElementById("welcomeSection")?.classList.remove("hidden");
            return;
        }

        try {
            const res = await fetch("/me", {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });

            if (res.status === 401) {
              localStorage.removeItem("access_token");
              location.reload();
              return;
            }

            if (res.ok) {
                const user = await res.json();
                const avatar = document.getElementById("userAvatar");
                avatar.textContent = user.username.charAt(0).toUpperCase();
                avatar.style.backgroundColor = user.avatar_color || getRandomColor();

                document.getElementById("authButtons").classList.add("hidden");
                document.getElementById("avatarBlock").classList.remove("hidden");
                document.getElementById("newProjectBlock").classList.remove("hidden");
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:", error);
        }
    }

    function getRandomColor() {
        const colors = ["#F59E0B", "#10B981", "#6366F1", "#EF4444", "#3B82F6", "#8B5CF6"];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // –ú–æ–¥–∞–ª–∫–∏
    function openModal(modal) {
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
    }

    function closeModal(modal) {
        modal.classList.remove("active");
        document.body.style.overflow = "auto";
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"
    const newProjectBtn = document.getElementById("newProjectBtn");
    const projectModal = document.getElementById("projectModal");
    const closeProjectModalBtn = document.getElementById("closeProjectModalBtn");
    const cancelProjectBtn = document.getElementById("cancelProjectBtn");

    newProjectBtn?.addEventListener("click", () => openModal(projectModal));
    closeProjectModalBtn?.addEventListener("click", () => closeModal(projectModal));
    cancelProjectBtn?.addEventListener("click", () => closeModal(projectModal));

    const projectForm = document.getElementById("projectForm");

        projectForm?.addEventListener("submit", async (e) => {
          e.preventDefault();

          const name = document.getElementById("projectName").value;
          const description = document.getElementById("projectDescription").value;
          const startDate = document.getElementById("projectStartDate").value;
          const endDate = document.getElementById("projectEndDate").value;

          const token = localStorage.getItem("access_token");

          if (!token) {
              alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã");
              return;
          }

          const payload = {
              name,
              description,
              start_date: startDate,
              end_date: endDate
          };

          const res = await fetch(`/projects/?t=${Date.now()}`, {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify(payload)
          });

          if (res.ok) {
              const newProject = await res.json();
        
              loadProjects();

              closeModal(projectModal);
              projectForm.reset();
          } else {
              const err = await res.json();
              alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞: " + err.detail);
          }
      });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
        const editProjectModal = document.getElementById("editProjectModal");
        const closeEditProjectModalBtn = document.getElementById("closeEditProjectModalBtn");
        const cancelEditProjectBtn = document.getElementById("cancelEditProjectBtn");
        const editProjectForm = document.getElementById("editProjectForm");

        closeEditProjectModalBtn?.addEventListener("click", () => closeModal(editProjectModal));
        cancelEditProjectBtn?.addEventListener("click", () => closeModal(editProjectModal));

        editProjectForm?.addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = document.getElementById("editProjectId").value;
            const name = document.getElementById("editProjectName").value;
            const description = document.getElementById("editProjectDescription").value;
            const startDate = document.getElementById("editProjectStartDate").value;
            const endDate = document.getElementById("editProjectEndDate").value;

            const res = await fetch(`/projects/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                },
                body: JSON.stringify({ name, description, start_date: startDate, end_date: endDate })
            });

            if (res.ok) {
                closeModal(editProjectModal);
                loadProjects(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞");
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –∑–∞–¥–∞—á–∏
        const taskForm = document.getElementById("taskForm");
        const taskModal = document.getElementById("taskModal");
        const cancelTaskBtn = document.getElementById("cancelTaskBtn");
        const closeModalBtn = document.getElementById("closeModalBtn");

        document.querySelectorAll(".add-task-btn").forEach(button => {
            button.addEventListener("click", (e) => {

                const column = e.target.closest(".kanban-column");
                const statusZone = column?.querySelector(".dropzone");
                const defaultStatus = statusZone?.dataset.status || "backlog";

                document.getElementById("taskStatus").value = defaultStatus;
                openModal(taskModal);
            });
        });

        closeModalBtn?.addEventListener("click", () => closeModal(taskModal));
        closeModalBtn?.addEventListener("click", () => {
          taskForm.reset();
          closeModal(taskModal);
        });
        cancelTaskBtn?.addEventListener("click", () => closeModal(taskModal));
        cancelTaskBtn?.addEventListener("click", () => {
          taskForm.reset();
          closeModal(taskModal);
        });

        if (taskForm) {
          taskForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const rawTitle = document.getElementById("taskTitle").value.trim();
            const rawDescription = document.getElementById("taskDescription").value.trim();
            const priority = document.getElementById("taskPriority").value;
            const due_date = document.getElementById("taskDueDate").value || new Date().toISOString().split("T")[0];
            const status = document.getElementById("taskStatus").value || "backlog";

            if (!rawTitle || !rawDescription) {
              alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏.");
              return;
            }

            const projectId = document.getElementById("taskModal").dataset.projectId;

            const payload = {
              title: rawTitle,
              description: rawDescription,
              priority,
              due_date,
              status,
              project_id: Number(projectId)
            };

            const res = await fetch("/tasks/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("access_token")}`
              },
              body: JSON.stringify(payload)
            });

            if (res.ok) {
              const newTask = await res.json();
              addTaskToBoard(newTask, newTask.project_id);
              updateTaskCounts();
              closeModal(taskModal);
              taskModal.dataset.projectId = "";
              taskForm.reset();
            } else {
              const err = await res.json();
              alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:\n" + (
                Array.isArray(err.detail)
                  ? err.detail.map(d => d.msg).join(", ")
                  : err.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"
              ));
            }
          });
        }

    // –í—Ö–æ–¥
    const loginBtn = document.getElementById("loginBtn");
    const loginModal = document.getElementById("loginModal");
    const loginForm = document.getElementById("loginForm");
    const cancelLoginBtn = document.getElementById("cancelLoginBtn");

    loginBtn?.addEventListener("click", () => openModal(loginModal));
    cancelLoginBtn?.addEventListener("click", () => closeModal(loginModal));

    const closeLoginModalBtn = document.getElementById("closeLoginModalBtn");
    closeLoginModalBtn?.addEventListener("click", () => closeModal(loginModal));

    loginForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;

        const res = await fetch("/token", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ username, password })
        });

        if (res.ok) {
            const data = await res.json();
            localStorage.setItem("access_token", data.access_token);
            closeModal(loginModal);
            loginForm.reset();
            location.reload();
        } else {
            const err = await res.json();
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.detail);
        }
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    const registerBtn = document.getElementById("registerBtn");
    const registrationModal = document.getElementById("registrationModal");
    const registrationForm = document.getElementById("registrationForm");
    const cancelRegisterBtn = document.getElementById("cancelRegisterBtn");

    registerBtn?.addEventListener("click", () => openModal(registrationModal));
    cancelRegisterBtn?.addEventListener("click", () => closeModal(registrationModal));

    const closeRegisterModalBtn = document.getElementById("closeRegisterModalBtn");
    closeRegisterModalBtn?.addEventListener("click", () => closeModal(registrationModal));

    registrationForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("registerUsername").value;
        const password = document.getElementById("registerPassword").value;

        const res = await fetch("/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        if (res.ok) {
            alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
            closeModal(registrationModal);
            registrationForm.reset();
        } else {
            const err = await res.json();
            alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + err.detail);
        }
    });

    // –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∞–≤–∞—Ç–∞—Ä
    const avatar = document.getElementById("userAvatar");
    const dropdown = document.getElementById("avatarDropdown");

    avatar?.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("hidden");
        
        const hint = document.getElementById("onboardingHint");

        // –ï—Å–ª–∏ –º–µ–Ω—é –û–¢–ö–†–´–¢–û ‚Üí —Å–∫—Ä—ã—Ç—å –≥–∏–¥
        if (!dropdown.classList.contains("hidden")) {
          hint?.classList.add("hidden");
        } else {
          // –ï—Å–ª–∏ –º–µ–Ω—é –ó–ê–ö–†–´–¢–û –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —Å–æ–∑–¥–∞–ª –ø—Ä–æ–µ–∫—Ç–æ–≤ ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –≥–∏–¥
          checkShouldShowOnboardingHint();
        }
      });

    document.addEventListener("click", (e) => {
        if (!avatar.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add("hidden");
            checkShouldShowOnboardingHint();
        }
    });

    document.getElementById("projectList").addEventListener("click", (e) => {
      const button = e.target.closest(".add-task-btn");
      if (!button) return;

      const column = button.closest(".kanban-column");
      const zone = column.querySelector(".dropzone");
      const defaultStatus = zone.dataset.status;
      const projectId = zone.dataset.projectId;

      document.getElementById("taskStatus").value = defaultStatus;
      document.getElementById("taskModal").dataset.projectId = projectId;
      openModal(document.getElementById("taskModal"));
    });

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞
    document.getElementById("logoutBtn")?.addEventListener("click", () => {
        if (confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) {
            localStorage.removeItem("access_token");
            location.reload();
        }
    });

    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ü—Ä–æ—Ñ–∏–ª—è –∏ –ù–∞—Å—Ç—Ä–æ–µ–∫
    document.getElementById("profileBtn")?.addEventListener("click", () => {
        alert("–†–∞–∑–¥–µ–ª '–ü—Ä–æ—Ñ–∏–ª—å' –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.");
    });
    document.getElementById("settingsBtn")?.addEventListener("click", () => {
        alert("–†–∞–∑–¥–µ–ª '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.");
    });

        document.addEventListener("click", async (e) => {
        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
        if (e.target.classList.contains("deleteProjectBtn")) {
            const id = e.target.dataset.id;
            if (confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) {
                const res = await fetch(`/projects/${id}`, {
                    method: "DELETE",
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem("access_token")}`
                    }
                });
                if (res.ok) {
                    loadProjects();
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞");
                }
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
        if (e.target.classList.contains("editProjectBtn")) {
            const id = e.target.dataset.id;

            // –ü–æ–ª—É—á–∏–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
            const res = await fetch(`/projects/${id}`, {
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                }
            });

            if (res.ok) {
                const project = await res.json();
                // –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById("editProjectId").value = project.id;
                document.getElementById("editProjectName").value = project.name;
                document.getElementById("editProjectDescription").value = project.description;
                document.getElementById("editProjectStartDate").value = project.start_date;
                document.getElementById("editProjectEndDate").value = project.end_date;

                // –û—Ç–∫—Ä–æ–π –º–æ–¥–∞–ª–∫—É
                openModal(editProjectModal);
            } else {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞");
            }
        }
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–Ω—é –∑–∞–¥–∞—á –ø–æ –∫–Ω–æ–ø–∫–µ ‚ãÆ
        if (e.target.closest(".task-options-btn")) {
          const card = e.target.closest(".task-card");
          const menu = card.querySelector(".task-dropdown-menu");

          document.querySelectorAll(".task-dropdown-menu").forEach(m => {
            if (m !== menu) m.classList.add("hidden");
          });

          menu.classList.toggle("hidden");
          e.stopPropagation();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –∑–∞–¥–∞—á –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        if (!e.target.closest(".task-card")) {
          document.querySelectorAll(".task-dropdown-menu").forEach(m => m.classList.add("hidden"));
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        if (e.target.classList.contains("task-delete-trigger")) {
          const card = e.target.closest(".task-card");
          const id = card.dataset.taskId;

          if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")) {
            const res = await fetch(`/tasks/${id}`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("access_token")}`
              }
            });

            if (res.ok) {
              card.remove();
              updateTaskCounts();
            } else {
              alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏");
            }
          }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        if (e.target.classList.contains("task-edit-trigger")) {
          const card = e.target.closest(".task-card");
          const id = card.dataset.taskId;

          const res = await fetch(`/tasks/${id}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("access_token")}`
            }
          });

          if (res.ok) {
            const task = await res.json();
            // –û—Ç–º–µ—Ç–∏–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            document.querySelectorAll("#editTaskModal input[type='checkbox']").forEach(cb => cb.checked = false);
            if (task.assignee) {
              const checkbox = document.querySelector(`#editTaskModal input[data-user-id="${task.assignee}"]`);
              if (checkbox) checkbox.checked = true;
            }
            document.getElementById("editTaskDueDate").value = task.due_date;
            document.getElementById("editTaskId").value = task.id;
            document.getElementById("editTaskTitle").value = task.title;
            document.getElementById("editTaskDescription").value = task.description;
            document.getElementById("editTaskPriority").value = task.priority;
            document.getElementById("editTaskStatus").value = task.status;
            openModal(document.getElementById("editTaskModal"));
          } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É");
          }
        }

        document.getElementById("closeEditTaskModalBtn")?.addEventListener("click", () =>
          closeModal(document.getElementById("editTaskModal"))
        );
        document.getElementById("cancelEditTaskBtn")?.addEventListener("click", () =>
          closeModal(document.getElementById("editTaskModal"))
        );

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        const editTaskForm = document.getElementById("editTaskForm");
        editTaskForm?.addEventListener("submit", async (e) => {
          e.preventDefault();

          const id = document.getElementById("editTaskId").value;
          const title = document.getElementById("editTaskTitle").value;
          const description = document.getElementById("editTaskDescription").value;
          const priority = document.getElementById("editTaskPriority").value;
          const status = document.getElementById("editTaskStatus").value;

          // –ü–æ–ª—É—á–∞–µ–º —Å—Ä–æ–∫ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
          const due_date = document.getElementById("editTaskDueDate").value || new Date().toISOString().split("T")[0];

          let assignee = null;
          document.querySelectorAll("#editTaskModal input[type='checkbox']").forEach(cb => {
            if (cb.checked) {
              assignee = cb.dataset.userId;
            }
          });

          const payload = {
            title,
            description,
            priority,
            status,
            due_date,
            assignee
          };

          const res = await fetch(`/tasks/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${localStorage.getItem("access_token")}`
            },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            closeModal(document.getElementById("editTaskModal"));
            loadTasks(); // –æ–±–Ω–æ–≤–∏–º –∑–∞–¥–∞—á–∏
          } else {
            const err = await res.json();
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: " + (err.detail || "422 Unprocessable Entity"));
          }
        });
    });
});

async function loadProjects() {
  console.log("–ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã...");
  const token = localStorage.getItem("access_token");
  if (!token) return;

  try {
    const res = await fetch("/projects/", {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (res.ok) {
      const projects = await res.json();
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–π–¥, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–µ—Ç
      const onboardingHint = document.getElementById("onboardingHint");

      if (projects.length === 0) {
        onboardingHint?.classList.remove("hidden");
      } else {
        onboardingHint?.classList.add("hidden");
      }
      console.log("–ü—Ä–æ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", projects);
      const container = document.querySelector("#projectList");
      container.innerHTML = ""; // –æ—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π

      projects.forEach(project => {
        addProjectToBoard(project);
      });
      initializeDragAndDrop();
    } else {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤");
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:", error);
  }
}

function formatDate(dateString) {
  if (!dateString) return "";
  const date = new Date(dateString);
  return date.toLocaleDateString("ru-RU", {
    year: "numeric",
    month: "short",
    day: "numeric"
  });
}

function addProjectToBoard(project) {
  const container = document.querySelector("#projectList");

  const projectCard = document.createElement("div");
  projectCard.className = "bg-white rounded-xl shadow-md p-6 mb-6";

  const startDateFormatted = formatDate(project.start_date);
  const endDateFormatted = formatDate(project.end_date);

  projectCard.innerHTML = `
    <div class="flex justify-between items-start flex-col md:flex-row gap-4 mb-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">${project.name}</h2>
        <p class="text-gray-600 mt-2">${project.description}</p>
      </div>
      <div class="flex flex-col md:items-end text-sm space-y-2">
        <div class="flex gap-6">
          <div class="flex flex-col items-center text-center">
            <p class="text-gray-500">–°—Ä–æ–∫</p>
            <p class="font-semibold">${startDateFormatted} ‚Äì ${endDateFormatted}</p>
          </div>
          <div class="flex flex-col items-center text-center">
            <p class="text-gray-500">–ü—Ä–æ–≥—Ä–µ—Å—Å</p>
            <div class="w-32 bg-gray-200 rounded-full h-2.5">
              <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${project.progress || 0}%"></div>
            </div>
          </div>
        </div>
        <div class="flex gap-2 pt-2 self-end">
          <button data-id="${project.id}" class="editProjectBtn bg-yellow-100 text-yellow-800 px-3 py-1 rounded-md hover:bg-yellow-200 text-sm">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button data-id="${project.id}" class="deleteProjectBtn bg-red-100 text-red-800 px-3 py-1 rounded-md hover:bg-red-200 text-sm">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" data-project-id="${project.id}">
      ${["backlog", "todo", "inprogress", "done"].map(status => `
        <div class="kanban-column bg-gray-100 rounded-xl p-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-gray-700">${translateStatus(status)}</h3>
            <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs font-medium" id="${status}Count-${project.id}">0 –∑–∞–¥–∞—á</span>
          </div>
          <div class="dropzone" data-status="${status}" data-project-id="${project.id}"></div>
          <button class="add-task-btn w-full mt-2 py-2 text-gray-500 hover:text-indigo-600 rounded-lg hover:bg-gray-200 transition flex items-center justify-center">
            <i class="fas fa-plus mr-2"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
          </button>
        </div>
      `).join("")}
    </div>
  `;

  container.appendChild(projectCard);

  fetch(`/projects/${project.id}/tasks`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem("access_token")}`
    }
  })
    .then(res => res.json())
    .then(tasks => {
      tasks.forEach(task => addTaskToBoard(task, project.id));
      updateTaskCounts(project.id);
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞:", err));
}

async function loadTasks() {
  const token = localStorage.getItem("access_token");
  if (!token) return;

  document.querySelectorAll(".dropzone").forEach(zone => zone.innerHTML = "");

  try {
    const res = await fetch("/tasks/", {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (res.ok) {
      const tasks = await res.json();
      tasks.forEach(task => addTaskToBoard(task));
      updateTaskCounts();
      initializeDragAndDrop();
    } else {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á");
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á:", error);
  }
}

function addTaskToBoard(task, projectId) {
  const zone = document.querySelector(`.dropzone[data-status="${task.status}"][data-project-id="${projectId}"]`);
  if (!zone) return;

  const card = document.createElement("div");
  card.className = `task-card bg-white rounded-lg shadow p-4 mb-4 status-${task.status}`;
  card.setAttribute("draggable", true);
  card.setAttribute("data-task-id", task.id);
  card.setAttribute("data-priority", task.priority);

  card.innerHTML = `
    <div class="flex justify-between items-start">
      <div class="flex-1">
        <h4 class="font-medium text-gray-800">${task.title}</h4>
        <div class="flex gap-2 mt-1">
          <span class="text-xs px-2 py-1 rounded ${getPriorityClass(task.priority)} priority-label">${translatePriority(task.priority)}</span>
          <span class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 status-label">${translateStatus(task.status)}</span>
        </div>
      </div>
      <div class="relative">
        <button class="task-options-btn text-gray-500 hover:text-gray-700">
          <i class="fas fa-ellipsis-v"></i>
        </button>
        <div class="task-dropdown-menu absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg py-1 z-50 hidden">
          <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 task-edit-trigger">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
          <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-100 task-delete-trigger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
        </div>
      </div>
    </div>
    <p class="text-sm text-gray-500 mt-2">${task.description}</p>
    <div class="flex items-center mt-4 text-sm text-gray-500">
      <i class="far fa-calendar-alt mr-2"></i>
      <span>–î–æ ${task.due_date}</span>
    </div>
  `;

  card.addEventListener("dragstart", () => {
    draggedTask = card;
    card.style.opacity = "0.5";
  });

  card.addEventListener("dragend", () => {
    card.style.opacity = "1";
    draggedTask = null;
  });

  zone.appendChild(card);
}

function initializeDragAndDrop() {
  document.querySelectorAll(".dropzone").forEach(zone => {
    zone.addEventListener("dragover", e => {
      e.preventDefault();
      zone.classList.add("dragover");
    });

    zone.addEventListener("dragleave", () => {
      zone.classList.remove("dragover");
    });

    zone.addEventListener("drop", async e => {
      e.preventDefault();
      zone.classList.remove("dragover");

      if (draggedTask) {
        const newStatus = zone.dataset.status;
        const taskId = draggedTask.dataset.taskId;

        draggedTask.classList.remove("status-backlog", "status-todo", "status-inprogress", "status-done");
        draggedTask.classList.add(`status-${newStatus}`);

        const statusLabel = draggedTask.querySelector(".status-label");
        if (statusLabel) {
          statusLabel.textContent = translateStatus(newStatus);
        }

        zone.appendChild(draggedTask);
        updateTaskCounts(zone.dataset.projectId);

        await fetch(`/tasks/${taskId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("access_token")}`
          },
          body: JSON.stringify({ status: newStatus })
        });
      }
    });
  });
}

function declineWord(number, one, few, many) {
  number = Math.abs(number) % 100;
  const n1 = number % 10;

  if (number > 10 && number < 20) return many;
  if (n1 > 1 && n1 < 5) return few;
  if (n1 === 1) return one;

  return many;
}

function updateTaskCounts(projectId = null) {
  const statuses = ["backlog", "todo", "inprogress", "done"];

  if (projectId) {
    statuses.forEach(status => {
      const zone = document.querySelector(`.dropzone[data-status="${status}"][data-project-id="${projectId}"]`);
      const count = zone ? zone.querySelectorAll(".task-card").length : 0;

      const countEl = document.getElementById(`${status}Count-${projectId}`);
      if (countEl) {
        countEl.textContent = `${count} ${declineWord(count, "–∑–∞–¥–∞—á–∞", "–∑–∞–¥–∞—á–∏", "–∑–∞–¥–∞—á")}`;
      }
    });
  } else {
    // –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
    document.querySelectorAll(".dropzone").forEach(zone => {
      const status = zone.dataset.status;
      const pid = zone.dataset.projectId;
      const count = zone.querySelectorAll(".task-card").length;
      const countEl = document.getElementById(`${status}Count-${pid}`);
      if (countEl) {
        countEl.textContent = `${count} ${declineWord(count, "–∑–∞–¥–∞—á–∞", "–∑–∞–¥–∞—á–∏", "–∑–∞–¥–∞—á")}`;
      }
    });
  }
}

function getPriorityClass(priority) {
  return {
    low: "bg-green-100 text-green-800",
    medium: "bg-yellow-100 text-yellow-800",
    high: "bg-red-100 text-red-800"
  }[priority] || "bg-gray-100 text-gray-800";
}

function translatePriority(priority) {
  return {
    low: "–ù–∏–∑–∫–∏–π",
    medium: "–°—Ä–µ–¥–Ω–∏–π",
    high: "–í—ã—Å–æ–∫–∏–π"
  }[priority] || priority;
}

function translateStatus(status) {
  return {
    backlog: "–ë—ç–∫–ª–æ–≥",
    todo: "–í –æ–∂–∏–¥–∞–Ω–∏–∏",
    inprogress: "–í —Ä–∞–±–æ—Ç–µ",
    done: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
  }[status] || status;
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

let draggedTask = null;

// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∏–¥
function checkShouldShowOnboardingHint() {
  const hint = document.getElementById("onboardingHint");

  const token = localStorage.getItem("access_token");
  if (!token) return;

  fetch("/projects/", {
    headers: {
      Authorization: `Bearer ${token}`
    }
  })
    .then(res => res.json())
    .then(projects => {
      if (projects.length === 0) {
        hint?.classList.remove("hidden");
      } else {
        hint?.classList.add("hidden");
      }
    })
    .catch(() => {
      hint?.classList.add("hidden");
    });
}

</script>

</body>
</html>
